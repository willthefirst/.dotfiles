name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: |
          VERSION=$(grep '^SHELLCHECK_VERSION' Makefile | cut -d'=' -f2 | tr -d ' ')
          wget -qO- "https://github.com/koalaman/shellcheck/releases/download/v${VERSION}/shellcheck-v${VERSION}.linux.x86_64.tar.xz" | tar -xJf -
          sudo cp "shellcheck-v${VERSION}/shellcheck" /usr/local/bin/

      - name: Run lint
        run: make lint

  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Install stow
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get install -y stow
          else
            brew install stow
          fi

      - name: Run tests
        run: make test

  validate-configs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate configs
        run: make validate

  dry-run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install stow
        run: sudo apt-get install -y stow

      - name: Test install script (dry run)
        run: |
          # Create isolated test environment
          export HOME=$(mktemp -d)
          export DOTFILES_DIR=$(pwd)
          mkdir -p "$HOME/.config" "$HOME/.ssh/sockets"
          chmod 700 "$HOME/.ssh"

          # Run install
          make install

          # Verify symlinks were created
          test -L "$HOME/.zshrc" || exit 1
          test -L "$HOME/.gitconfig" || exit 1
